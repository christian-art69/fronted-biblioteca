<div class="gestion-container">

  <div *ngIf="mensajeExito" class="success-message">{{ mensajeExito }}</div>
  <div *ngIf="mensajeError" class="error-api">{{ mensajeError }}</div>

  <div class="card">
    <div class="card-header">
      <h2>Gestión de Usuarios</h2>
      <button class="btn btn-primary" (click)="abrirModalNuevo()">
        Registrar Nuevo Usuario
      </button>
    </div>
    
    <div class="card-body">
      <div class="form-group">
        <label for="filtro">Buscar usuario (por Nombre, Correo o RUT)</label>
        <input type="text" id="filtro" class="form-control" [(ngModel)]="filtro" (input)="filtrarUsuarios()" placeholder="Escriba para buscar...">
      </div>

      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Correo</th>
              <th>RUT</th>
              <th>Rol</th>
              <th>Cargo</th>
              <th>Situación</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let usuario of usuariosFiltrados">
              <td>{{ usuario.nombre }}</td>
              <td>{{ usuario.correo }}</td>
              <td>{{ usuario.rut }}</td>
              <td>{{ usuario.rol }}</td>
              <td>{{ usuario.cargo }}</td>
              <td>
                <span class="user-status" [attr.data-situacion]="usuario.situacion">
                  {{ usuario.situacion }}
                </span>
              </td>
              <td class="actions">
                <button class="btn btn-secondary" (click)="abrirModalEditar(usuario)">Editar</button>
                <button class="btn btn-danger" (click)="eliminarUsuario(usuario._id!)">Eliminar</button>
              </td>
            </tr>
            <tr *ngIf="usuariosFiltrados.length === 0">
              <td colspan="7" style="text-align: center;">
                No se encontraron usuarios que coincidan con la búsqueda.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div *ngIf="modalVisible" class="modal-backdrop" (click)="cerrarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    
    <form [formGroup]="usuarioForm" (ngSubmit)="guardarUsuario()">
      
      <div class="modal-header">
        <h3>{{ esModoEdicion ? 'Editar Usuario' : 'Registrar Nuevo Usuario' }}</h3>
      </div>

      <div class="modal-body">
        
        <div class="form-grid">

          <div class="form-group">
            <label for="nombre">Nombre Completo</label>
            <input type="text" id="nombre" class="form-control" formControlName="nombre"
                   [class.is-invalid]="f['nombre'].invalid && f['nombre'].touched">
            <div *ngIf="f['nombre'].invalid && f['nombre'].touched" class="error-message">
              <span *ngIf="f['nombre'].errors?.['required']">El nombre es obligatorio.</span>
            </div>
          </div>

          <div class="form-group">
            <label for="correo">Correo Electrónico</label>
            <input type="email" id="correo" class="form-control" formControlName="correo"
                   [class.is-invalid]="f['correo'].invalid && f['correo'].touched">
            <div *ngIf="f['correo'].invalid && f['correo'].touched" class="error-message">
              <span *ngIf="f['correo'].errors?.['required']">El correo es obligatorio.</span>
              <span *ngIf="f['correo'].errors?.['email']">El correo no es válido.</span>
            </div>
          </div>

          <div class="form-group">
            <label for="rut">RUT</label>
            <input type="text" id="rut" class="form-control" formControlName="rut"
                   placeholder="Ej: 12.345.678-9"
                   [class.is-invalid]="f['rut'].invalid && f['rut'].touched">
            <div *ngIf="f['rut'].invalid && f['rut'].touched" class="error-message">
              <span *ngIf="f['rut'].errors?.['required']">El RUT es obligatorio.</span>
              <span *ngIf="f['rut'].errors?.['pattern']">Formato de RUT no válido.</span>
            </div>
          </div>

          <div class="form-group">
            <label for="password">Contraseña</label>
            <input type="password" id="password" class="form-control" formControlName="password"
                   [placeholder]="esModoEdicion ? '(Dejar en blanco para no cambiar)' : ''"
                   [class.is-invalid]="f['password'].invalid && f['password'].touched">
            <div *ngIf="f['password'].invalid && f['password'].touched" class="error-message">
              <span *ngIf="f['password'].errors?.['required']">La contraseña es obligatoria.</span>
              <span *ngIf="f['password'].errors?.['minlength']">Debe tener al menos 6 caracteres.</span>
            </div>
          </div>

          <div class="form-group">
            <label for="rol">Rol</label>
            <select id="rol" class="form-select" formControlName="rol">
              <option *ngFor="let rol of roles" [value]="rol">{{ rol }}</option>
            </select>
          </div>

          <div class="form-group">
            <label for="cargo">Cargo</label>
            <select id="cargo" class="form-select" formControlName="cargo">
              <option *ngFor="let cargo of cargos" [value]="cargo">{{ cargo }}</option>
            </select>
          </div>

          <div class="form-group" *ngIf="esModoEdicion">
            <label for="situacion">Situación</label>
            <select id="situacion" class="form-select" formControlName="situacion">
              <option *ngFor="let sit of situaciones" [value]="sit">{{ sit }}</option>
            </select>
          </div>

        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
        <button type="submit" class="btn btn-primary" [disabled]="usuarioForm.invalid">
          {{ esModoEdicion ? 'Actualizar Usuario' : 'Registrar Usuario' }}
        </button>
      </div>

    </form>
  </div>
</div>