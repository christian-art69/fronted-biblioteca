<section class="panel">
  <h2>Gestión de Usuarios</h2>

  <div class="busqueda-container">
    <input 
      type="text" 
      placeholder="Buscar por nombre o rut..." 
      [(ngModel)]="terminoBusqueda"
      (keyup.enter)="cargarUsuarios()">
    <button (click)="cargarUsuarios()">Buscar</button>
  </div>


  <form class="formulario" (ngSubmit)="registrarUsuario()">
  
    <input type="text" placeholder="Nombre" [(ngModel)]="nuevoUsuario.nombre" name="nombre" required />
    <input type="email" placeholder="Correo" [(ngModel)]="nuevoUsuario.correo" name="correo" required />

    <input 
      type="text" 
      placeholder="RUT" 
      [(ngModel)]="nuevoUsuario.rut" 
      name="rut" 
      autocomplete="off" /> <input 
      type="password" 
      placeholder="Contraseña" 
      [(ngModel)]="nuevoUsuario.password" 
      name="password" 
      autocomplete="new-password" required />

    <select [(ngModel)]="nuevoUsuario.rol" name="rol" required>
      <option value="Usuario">Usuario</option>
      <option value="Admin">Admin</option>
    </select>

    <select [(ngModel)]="nuevoUsuario.cargo" name="cargo" required>
      <option value="Estudiante">Estudiante</option>
      <option value="Docente">Docente</option>
      <option value="Bibliotecario">Bibliotecario</option>
    </select>
    
    <button type="submit">Registrar Usuario</button>
  </form>

  <table class="tabla">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Correo</th>
        <th>RUT</th>
        <th>Situación</th>
        <th>Rol</th>
        <th>Cargo</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let usuario of usuarios">
        <td>{{ usuario.nombre }}</td>
        <td>{{ usuario.correo }}</td>
        <td>{{ usuario.rut }}</td>
        <td>
          <span [class.vigente]="usuario.situacion === 'Vigente'" 
                [class.atrasado]="usuario.situacion === 'Atrasado'"
                [class.bloqueado]="usuario.situacion === 'Bloqueado'"
                [class.prestamoActivo]="usuario.situacion === 'Prestamo Activo'">
            {{ usuario.situacion }}
        </span>
        </td>
        <td>{{ usuario.rol }}</td>
        <td>{{ usuario.cargo }}</td>
        <td>
          <button (click)="editarUsuario(usuario)">Editar</button>
          <button (click)="eliminarUsuario(usuario)">Eliminar</button>
        </td>
      </tr>
    </tbody>
  </table>
</section>

<div class="modal-backdrop" *ngIf="usuarioSeleccionado">
  <div class="modal-content">
    
    <div class="modal-header">
      <h2>Editar Usuario</h2>
      <button (click)="cerrarModal()" class="close-button">&times;</button>
    </div>

    <div class="modal-body" *ngIf="usuarioSeleccionado">
      <div class="form-group">
        <label for="editNombre">Nombre</label>
        <input id="editNombre" type="text" [(ngModel)]="usuarioSeleccionado.nombre" name="nombre">
      </div>
      <div class="form-group">
        <label for="editCorreo">Correo</label>
        <input id="editCorreo" type="email" [(ngModel)]="usuarioSeleccionado.correo" name="correo">
      </div>
      <div class="form-group">
        <label for="editRut">RUT</label>
        <input id="editRut" type="text" [(ngModel)]="usuarioSeleccionado.rut" name="rut">
      </div>
      <div class="form-group">
        <label for="editPassword">Nueva Contraseña</label>
        <input 
          id="editPassword" 
          type="password" 
          [(ngModel)]="nuevaPasswordModal" 
          name="passwordModal"
          autocomplete="new-password"
          placeholder="Dejar en blanco para no cambiar">
      </div>

      <div class="form-group">
        <label for="editSituacion">Situación</label>
        <select id="editSituacion" [(ngModel)]="usuarioSeleccionado.situacion" name="situacion">
          <option value="Vigente">Vigente</option>
          <option value="Atrasado">Atrasado</option>
          <option value="Bloqueado">Bloqueado</option>
          <option value="Prestamo Activo">Prestamo Activo</option>
        </select>
      </div>

      <div class="form-group">
        <label for="editRol">Rol</label>
        <select id="editRol" [(ngModel)]="usuarioSeleccionado.rol" name="rol">
          <option value="Usuario">Usuario</option>
          <option value="Admin">Admin</option>
        </select>
      </div>

      <div class="form-group">
        <label for="editCargo">Cargo</label>
        <select id="editCargo" [(ngModel)]="usuarioSeleccionado.cargo" name="cargo">
          <option value="Estudiante">Estudiante</option>
          <option value="Docente">Docente</option>
          <option value="Bibliotecario">Bibliotecario</option>
        </select>
      </div>
    </div>

    <div class="modal-footer">
      <button (click)="cerrarModal()" class="btn-cancelar">Cancelar</button>
      <button (click)="guardarCambios()" class="btn-guardar">Guardar Cambios</button>
    </div>
    
  </div>
</div>
