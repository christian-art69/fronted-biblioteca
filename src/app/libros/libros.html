<div class="gestion-container">

  <div *ngIf="mensajeExito" class="success-message">{{ mensajeExito }}</div>
  <div *ngIf="mensajeError" class="error-api">{{ mensajeError }}</div>

  <div class="card">
    <div class="card-header">
      <h2>Catálogo de Libros</h2>
      <button *ngIf="authService.role() === 'Admin'" class="btn btn-primary" (click)="abrirModalNuevo()">
        Agregar Nuevo Libro
      </button>
    </div>
    
    <div class="card-body">
      <div class="form-group">
        <label for="filtro">Buscar libro (por Título, Autor o Género)</label>
        <input type="text" id="filtro" class="form-control" [(ngModel)]="filtro" (input)="filtrarLibros()" placeholder="Escriba para buscar...">
      </div>

      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Título</th>
              <th>Autor</th>
              <th>Género</th>
              <th>Año</th>
              <th>Cantidad</th>
              <th *ngIf="authService.role() === 'Admin'">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let libro of librosFiltrados">
              <td>{{ libro.titulo }}</td>
              <td>{{ libro.autor }}</td>
              <td>{{ libro.genero }}</td>
              <td>{{ libro.ano }}</td>
              <td>{{ libro.cantidad }}</td>
              <td *ngIf="authService.role() === 'Admin'" class="actions">
                <button class="btn btn-secondary" (click)="abrirModalEditar(libro)">Editar</button>
                <button class="btn btn-danger" (click)="eliminarLibro(libro._id!)">Eliminar</button>
              </td>
            </tr>
            <tr *ngIf="librosFiltrados.length === 0">
              <td [attr.colspan]="authService.role() === 'Admin' ? 6 : 5" style="text-align: center;">
                No se encontraron libros que coincidan con la búsqueda.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div *ngIf="modalVisible" class="modal-backdrop" (click)="cerrarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    
    <form [formGroup]="libroForm" (ngSubmit)="guardarLibro()">
      
      <div class="modal-header">
        <h3>{{ esModoEdicion ? 'Editar Libro' : 'Agregar Nuevo Libro' }}</h3>
      </div>

      <div class="modal-body">
        
        <div class="form-group">
          <label for="titulo">Título</label>
          <input type="text" id="titulo" class="form-control" formControlName="titulo"
                 [class.is-invalid]="f['titulo'].invalid && f['titulo'].touched">
          <div *ngIf="f['titulo'].invalid && f['titulo'].touched" class="error-message">
            <span *ngIf="f['titulo'].errors?.['required']">El título es obligatorio.</span>
            <span *ngIf="f['titulo'].errors?.['minlength']">Debe tener al menos 3 caracteres.</span>
          </div>
        </div>

        <div class="form-group">
          <label for="autor">Autor</label>
          <input type="text" id="autor" class="form-control" formControlName="autor"
                 [class.is-invalid]="f['autor'].invalid && f['autor'].touched">
          <div *ngIf="f['autor'].invalid && f['autor'].touched" class="error-message">
            <span *ngIf="f['autor'].errors?.['required']">El autor es obligatorio.</span>
            <span *ngIf="f['autor'].errors?.['minlength']">Debe tener al menos 3 caracteres.</span>
          </div>
        </div>

        <div class="form-group">
          <label for="genero">Género</label>
          <input type="text" id="genero" class="form-control" formControlName="genero"
                 [class.is-invalid]="f['genero'].invalid && f['genero'].touched">
          <div *ngIf="f['genero'].invalid && f['genero'].touched" class="error-message">
            <span *ngIf="f['genero'].errors?.['required']">El género es obligatorio.</span>
          </div>
        </div>

        <div class="form-group">
          <label for="ano">Año</label>
          <input type="number" id="ano" class="form-control" formControlName="ano"
                 [class.is-invalid]="f['ano'].invalid && f['ano'].touched">
          <div *ngIf="f['ano'].invalid && f['ano'].touched" class="error-message">
            <span *ngIf="f['ano'].errors?.['required']">El año es obligatorio.</span>
            <span *ngIf="f['ano'].errors?.['min'] || f['ano'].errors?.['max']">Debe ser un año válido.</span>
          </div>
        </div>

        <div class="form-group">
          <label for="cantidad">Cantidad</label>
          <input type="number" id="cantidad" class="form-control" formControlName="cantidad"
                 [class.is-invalid]="f['cantidad'].invalid && f['cantidad'].touched">
          <div *ngIf="f['cantidad'].invalid && f['cantidad'].touched" class="error-message">
            <span *ngIf="f['cantidad'].errors?.['required']">La cantidad es obligatoria.</span>
            <span *ngIf="f['cantidad'].errors?.['min']">La cantidad no puede ser negativa.</span>
          </div>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
        <button type="submit" class="btn btn-primary" [disabled]="libroForm.invalid">
          {{ esModoEdicion ? 'Actualizar' : 'Guardar' }}
        </button>
      </div>

    </form>
  </div>
</div>